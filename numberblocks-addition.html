<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Math Lab: Sandbox</title>
    <style>
        body {
            background-color: #f0f4f8; 
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
            margin: 0; padding: 0;
            /* Use dvh (dynamic viewport height) to handle mobile address bars better */
            height: 100vh; height: 100dvh; 
            width: 100vw;
            overflow: hidden; user-select: none; touch-action: none;
            display: flex; flex-direction: column;
        }

        /* --- START OVERLAY --- */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        #start-title {
            font-size: 32px; color: #333; margin-bottom: 30px; text-align: center;
        }

        #start-btn {
            font-size: 30px; padding: 15px 50px;
            background: #ff4d4d; color: white;
            border: 4px solid #d63031; border-radius: 20px;
            box-shadow: 0 8px 0 #d63031;
            cursor: pointer; font-family: inherit; font-weight: bold;
            transition: transform 0.1s;
        }
        #start-btn:active { transform: translateY(5px); box-shadow: 0 3px 0 #d63031; }

        /* HEADER */
        .header {
            height: 50px; background: white; border-bottom: 2px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .btn {
            text-decoration: none; font-size: 14px; background: white; 
            padding: 5px 12px; border-radius: 12px; border: 2px solid #ddd; 
            color: #555; font-weight: bold; box-shadow: 0 3px 0 #eee; cursor: pointer;
        }

        #lang-select {
            font-size: 14px; padding: 5px; border-radius: 10px;
            border: 2px solid #ddd; font-weight: bold; color: #555;
        }

        /* WORKSPACE */
        #workspace { 
            display: flex; flex-grow: 1; height: calc(100% - 50px); position: relative; 
            justify-content: space-between;
        }

        /* GENERAL SIDEBAR SETUP */
        .sidebar {
            width: 160px; 
            background: #eef2f5; 
            overflow-y: auto; overflow-x: hidden;
            position: relative; /* Anchor for absolute items */
            box-sizing: border-box; flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
        }

        #sidebar-left { border-right: 2px solid #ddd; }
        #sidebar-right { border-left: 2px solid #ddd; }

        .sidebar-title {
            position: absolute; top: 10px; width: 100%;
            text-align: center; 
            font-size: 14px; color: #888; font-weight: bold; text-transform: uppercase;
        }

        /* SIDEBAR ITEM BASE */
        .sidebar-item {
            position: absolute; /* Exact control */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: grab; height: 60px; width: 70px;
        }
        .sidebar-item:active { transform: scale(0.9); }

        /* ============================================================
           --- LEFT SIDEBAR SETTINGS (Odds: 1, 3, 5, 7, 9) ---
           ============================================================ */
        
        /* Vertical Positions (Y) - USER DEFINED */
        #sidebar-left .pos-y-1 { top: 50px; }   /* 1 & 3 */
        #sidebar-left .pos-y-2 { top: 150px; }  /* 5 & 7 */
        #sidebar-left .pos-y-3 { top: 250px; }  /* 9 */

        /* Horizontal Positions (X) */
        #sidebar-left .col-left { left: 5px; }   /* 1, 5 */
        #sidebar-left .col-right { right: 15px; } /* 3, 7 */
        #sidebar-left .col-center { left: 50%; transform: translateX(-50%); } /* 9 */


        /* ============================================================
           --- RIGHT SIDEBAR SETTINGS (Evens: 2, 4, 6, 8, 10) ---
           ============================================================ */
        
        /* Vertical Positions (Y) - USER DEFINED */
        #sidebar-right .pos-y-1 { top: 50px; }   /* 2 & 4 */
        #sidebar-right .pos-y-2 { top: 135px; }  /* 6 & 8 */
        #sidebar-right .pos-y-3 { top: 250px; }  /* 10 */

        /* Horizontal Positions (X) */
        #sidebar-right .col-left { left: 5px; }   /* 2, 6 */
        #sidebar-right .col-right { right: 15px; } /* 4, 8 */
        #sidebar-right .col-center { left: 50%; transform: translateX(-50%); } /* 10 */


        /* ============================================================ */

        .scroll-spacer {
            position: absolute; top: 400px; width: 100%; height: 50px; pointer-events: none;
        }

        .sidebar-preview {
            transform: scale(0.45); pointer-events: none; 
            display: flex; justify-content: center; align-items: center;
        }
        
        /* CANVAS */
        #canvas {
            flex-grow: 1; position: relative;
            background-image: radial-gradient(#d0d0d0 1px, transparent 1px);
            background-size: 20px 20px; 
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        #canvas-hint {
            position: absolute; color: #e0e0e0; font-size: 30px; font-weight: bold;
            text-align: center; pointer-events: none; width: 100%;
        }

        #trash-zone {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            width: 70px; height: 70px;
            border: 3px dashed #ff4d4d; border-radius: 20px;
            background: rgba(255, 77, 77, 0.05);
            display: flex; justify-content: center; align-items: center;
            font-size: 30px; opacity: 0.6; transition: all 0.2s;
            z-index: 50;
        }
        #trash-zone.hover { opacity: 1; transform: translateX(-50%) scale(1.1); background: rgba(255, 77, 77, 0.2); }

        /* BLOCKS */
        .block-container {
            position: absolute; display: grid; gap: 2px;
            cursor: grab; transition: transform 0.1s;
            z-index: 10; transform-origin: center center;
            touch-action: none;
        }
        .block-container.merge-target { filter: drop-shadow(0 0 10px gold); transform: scale(1.05); }

        /* SQUARE SHAKE */
        .square-shake {
            animation: shakeBlock 0.8s ease-in-out;
            filter: drop-shadow(0 0 15px gold);
        }
        @keyframes shakeBlock {
            0% { transform: rotate(0deg) scale(1); }
            20% { transform: rotate(-10deg) scale(1.2); }
            40% { transform: rotate(10deg) scale(1.2); }
            60% { transform: rotate(-10deg) scale(1.2); }
            80% { transform: rotate(5deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        .unit {
            width: 50px; height: 50px; border-radius: 10px; position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.15), 2px 2px 0 rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        /* COLORS */
        .c1 { background: #ff4d4d; border: 3px solid #d63031; }
        .c2 { background: #ff9f43; border: 3px solid #e67e22; }
        .c3 { background: #feca57; border: 3px solid #f1c40f; }
        .c4 { background: #00b894; border: 3px solid #00886e; }
        .c5 { background: #48dbfb; border: 3px solid #0abde3; }
        .c6 { background: #a29bfe; border: 3px solid #6c5ce7; }
        .c7 { background: #fd79a8; border: 3px solid #e84393; }
        .c8 { background: #e84393; border: 3px solid #c92876; }
        .c9 { background: #b2bec3; border: 3px solid #636e72; }
        .c10 { background: white; border: 4px solid #ff4d4d; }
        .c11 { background: #d63031; border: 3px solid #b71540; }
        .c12 { background: #e17055; border: 3px solid #d35400; }
        .c13 { background: #fdcb6e; border: 3px solid #e1b12c; }
        .c14 { background: #00cec9; border: 3px solid #00b894; }
        .c15 { background: #74b9ff; border: 3px solid #0984e3; }
        .c16 { background: #6c5ce7; border: 3px solid #4834d4; }
        .c17 { background: #ff7675; border: 3px solid #e056fd; }
        .c18 { background: #55efc4; border: 3px solid #00b894; }
        .c19 { background: #636e72; border: 3px solid #2d3436; }
        .c20 { background: #ffeaa7; border: 3px solid #fdcb6e; }
        .c_high { background: #a55eea; border: 3px solid #8854d0; } 

        /* FACE */
        .face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; padding-top: 4px; }
        .eyes-row { display: flex; justify-content: center; margin-bottom: 2px; }
        .eye { width: 12px; height: 12px; background: white; border-radius: 50%; border: 2px solid #222; position: relative; margin: 0 -1px; }
        .eye::after { content: ''; position: absolute; right: 2px; top: 3px; width: 3px; height: 3px; background: #222; border-radius: 50%; }
        .mouth { width: 14px; height: 5px; border-bottom: 2px solid #222; border-radius: 0 0 10px 10px; }

        @keyframes pop { 0% { transform: scale(0.5); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .spawn-anim { animation: pop 0.4s ease-out; }

        .block-value {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            font-size: 18px; color: #555; font-weight: bold; pointer-events: none;
            text-shadow: 1px 1px 0 white; white-space: nowrap;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <div id="start-title">Math Lab: Sandbox</div>
        <button id="start-btn" onclick="startGame()">PLAY ‚ñ∂</button>
    </div>

    <div class="header">
        <div style="display:flex; gap:10px; align-items:center;">
            <a href="index.html" class="btn">üè† Home</a>
            <select id="lang-select" onchange="changeLanguage()">
                <option value="en">üá∫üá∏ EN</option>
                <option value="ar">üá∏üá¶ AR</option>
                <option value="bn">üáßüá© BN</option>
            </select>
        </div>
        <div style="font-size: 18px; font-weight:bold; color:#555;">Math Lab</div>
        <button class="btn" style="color:red; border-color:red;" onclick="clearCanvas()">Clear All</button>
    </div>

    <div id="workspace">
        <div id="sidebar-left" class="sidebar">
            <div class="sidebar-title">Odds</div>
            <div class="scroll-spacer"></div>
        </div>

        <div id="canvas">
            <div id="canvas-hint">Drag Numbers Here!</div>
            <div id="trash-zone">üóë</div>
        </div>

        <div id="sidebar-right" class="sidebar">
            <div class="sidebar-title">Evens</div>
            <div class="scroll-spacer"></div>
        </div>
    </div>

    <script>
        let currentLang = 'en';
        let isInputLocked = false;
        const BLOCK_SIZE = 50;
        const GAP = 2;
        let blockIdCounter = 0;

        const SQUARE_NUMBERS = [4, 9, 16, 25, 36, 49, 64, 81, 100];

        const NUMBER_DATA = {
            1: { color: 'c1', en: '1', ar: 'Ÿ°', bn: '‡ßß' },
            2: { color: 'c2', en: '2', ar: 'Ÿ¢', bn: '‡ß®' },
            3: { color: 'c3', en: '3', ar: 'Ÿ£', bn: '‡ß©' },
            4: { color: 'c4', en: '4', ar: 'Ÿ§', bn: '‡ß™' },
            5: { color: 'c5', en: '5', ar: 'Ÿ•', bn: '‡ß´' },
            6: { color: 'c6', en: '6', ar: 'Ÿ¶', bn: '‡ß¨' },
            7: { color: 'c7', en: '7', ar: 'Ÿß', bn: '‡ß≠' },
            8: { color: 'c8', en: '8', ar: 'Ÿ®', bn: '‡ßÆ' },
            9: { color: 'c9', en: '9', ar: 'Ÿ©', bn: '‡ßØ' },
            10: { color: 'c10', en: '10', ar: 'Ÿ°Ÿ†', bn: '‡ßß‡ß¶' },
            11: { color: 'c11', en: '11', ar: 'Ÿ°Ÿ°', bn: '‡ßß‡ßß' },
            12: { color: 'c12', en: '12', ar: 'Ÿ°Ÿ¢', bn: '‡ßß‡ß®' },
            13: { color: 'c13', en: '13', ar: 'Ÿ°Ÿ£', bn: '‡ßß‡ß©' },
            14: { color: 'c14', en: '14', ar: 'Ÿ°Ÿ§', bn: '‡ßß‡ß™' },
            15: { color: 'c15', en: '15', ar: 'Ÿ°Ÿ•', bn: '‡ßß‡ß´' },
            16: { color: 'c16', en: '16', ar: 'Ÿ°Ÿ¶', bn: '‡ßß‡ß¨' },
            17: { color: 'c17', en: '17', ar: 'Ÿ°Ÿß', bn: '‡ßß‡ß≠' },
            18: { color: 'c18', en: '18', ar: 'Ÿ°Ÿ®', bn: '‡ßß‡ßÆ' },
            19: { color: 'c19', en: '19', ar: 'Ÿ°Ÿ©', bn: '‡ßß‡ßØ' },
            20: { color: 'c20', en: '20', ar: 'Ÿ¢Ÿ†', bn: '‡ß®‡ß¶' }
        };

        const MATH_PHRASES = {
            en: { plus: "plus", equals: "equals", square: "Excellent! {n} is a square number!" },
            ar: { plus: "ÿ≤ÿßÿ¶ÿØ", equals: "Ÿäÿ≥ÿßŸàŸä", square: "ŸÖŸÖÿ™ÿßÿ≤! {n} ŸáŸà ÿ±ŸÇŸÖ ŸÖÿ±ÿ®ÿπ!" },
            bn: { plus: "‡¶Ø‡ßã‡¶ó", equals: "‡¶∏‡¶Æ‡¶æ‡¶®", square: "‡¶ö‡¶Æ‡ßé‡¶ï‡¶æ‡¶∞! {n} ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶∞‡ßç‡¶ó‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ!" }
        };

        const canvas = document.getElementById('canvas');
        const trashZone = document.getElementById('trash-zone');
        const canvasHint = document.getElementById('canvas-hint');

        // --- FORCE FULL SCREEN + AUDIO UNLOCK ---
        function startGame() {
            document.getElementById('start-overlay').style.display = 'none';
            
            // 1. Attempt Full Screen
            let elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen().catch(err=>{});
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
            
            // 2. Unlock Audio Context
            if('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance('');
                window.speechSynthesis.speak(msg);
            }
        }

        function getColorClass(n) {
            if (NUMBER_DATA[n]) return NUMBER_DATA[n].color;
            if (n <= 20) return `c${n}`; 
            let cycle = (n - 1) % 10 + 1;
            return `c${cycle}`;
        }

        // --- INIT SIDEBARS ---
        function initSidebars() {
            const leftBar = document.getElementById('sidebar-left');
            const rightBar = document.getElementById('sidebar-right');
            
            leftBar.innerHTML = '<div class="sidebar-title">Odds</div><div class="scroll-spacer"></div>';
            rightBar.innerHTML = '<div class="sidebar-title">Evens</div><div class="scroll-spacer"></div>';

            for (let i = 1; i <= 10; i++) {
                const item = document.createElement('div');
                item.className = 'sidebar-item';
                
                // EXACT POSITIONING
                if (i <= 4) item.classList.add('pos-y-1');      
                else if (i <= 8) item.classList.add('pos-y-2'); 
                else item.classList.add('pos-y-3');             

                // X Position
                if (i === 9 || i === 10) item.classList.add('col-center');
                else if ([1, 5, 2, 6].includes(i)) item.classList.add('col-left');
                else item.classList.add('col-right');

                const previewWrap = document.createElement('div');
                previewWrap.className = 'sidebar-preview';
                const blockVisual = createBlockVisual(i, false); 
                previewWrap.appendChild(blockVisual);
                item.appendChild(previewWrap);

                const startHandler = (e) => {
                    spawnBlock(e, i);
                    speak(getLocalizedNumber(i)); 
                };
                item.addEventListener('touchstart', startHandler, {passive: false});
                item.addEventListener('mousedown', startHandler);
                
                if (i % 2 !== 0) leftBar.appendChild(item);
                else rightBar.appendChild(item);
            }
        }

        // --- BLOCK BUILDER ---
        function createBlockVisual(num, addLabel = true) {
            const container = document.createElement('div');
            container.className = 'block-container';
            const layout = getLayout(num);
            
            container.style.gridTemplateColumns = `repeat(${layout.cols}, 1fr)`;
            container.style.width = `${layout.cols * BLOCK_SIZE + (layout.cols-1)*GAP}px`;
            container.style.height = `${layout.rows * BLOCK_SIZE + (layout.rows-1)*GAP}px`;

            const headIndex = getHeadIndex(num);

            for(let i=0; i<num; i++) {
                const div = document.createElement('div');
                div.className = `unit ${getColorClass(num)}`;
                const pos = getGridPos(num, i, layout.cols);
                div.style.gridColumnStart = pos.col + 1;
                div.style.gridRowStart = (layout.rows - pos.row);

                if (i === headIndex) {
                    div.innerHTML = `<div class="face"><div class="eyes-row"><div class="eye"></div><div class="eye"></div></div><div class="mouth"></div></div>`;
                }
                container.appendChild(div);
            }

            if(addLabel) {
                const lbl = document.createElement('div');
                lbl.className = 'block-value';
                lbl.innerText = getLocalizedNumber(num);
                container.appendChild(lbl);
            }

            if(num > 20) {
                const screenH = window.innerHeight;
                const blockH = parseInt(container.style.height);
                if(blockH > screenH * 0.5) { 
                    const scale = (screenH * 0.5) / blockH;
                    container.style.transform = `scale(${scale})`;
                }
            }
            return container;
        }

        // --- SHAPE LOGIC ---
        function getLayout(n) {
            if (SQUARE_NUMBERS.includes(n)) {
                const root = Math.sqrt(n);
                return { cols: root, rows: root };
            }
            if (n > 20) {
                let cols = Math.ceil(Math.sqrt(n) * 1.3);
                let rows = Math.ceil(n / cols);
                return {cols, rows};
            }
            let cols=2, rows=Math.ceil(n/2);
            if(n==1){cols=1;rows=1;} else if(n==2){cols=2;rows=1;}
            else if(n==10){cols=2;rows=5;}
            else if(n > 10 && n <= 20) {
                if(n%5===0) cols=5; else if(n%4===0) cols=4; else cols=3;
                rows = Math.ceil(n/cols);
            }
            return {cols, rows};
        }

        function getGridPos(n, i, cols) {
            if (n > 10 || SQUARE_NUMBERS.includes(n)) { return { row: Math.floor(i/cols), col: i%cols }; }
            let row, col;
            if(n==2){row=0;col=i;}
            else if([3,5,7].includes(n)){ if(i==n-1){row=Math.floor((n-1)/2);col=0;} else{row=Math.floor(i/2);col=i%2;} }
            else if(n==1){row=0;col=0;}
            else {row=Math.floor(i/2);col=i%2;}
            return {row, col};
        }

        function getHeadIndex(num) {
            if([1,2].includes(num))return 0;
            if([3,5,7,11,13,15,17,19].includes(num)) return num-1;
            if(SQUARE_NUMBERS.includes(num)) return num-1;
            if(num==10) return 8; 
            if(num > 20) return 0;
            return num-1; 
        }

        function getLocalizedNumber(n) {
            if(NUMBER_DATA[n] && NUMBER_DATA[n][currentLang]) return NUMBER_DATA[n][currentLang];
            return n.toLocaleString(currentLang === 'ar' ? 'ar-SA' : (currentLang === 'bn' ? 'bn-BD' : 'en-US'));
        }

        function speak(text) {
            if('speechSynthesis' in window){
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance(text);
                if(currentLang === 'ar') msg.lang = 'ar-SA';
                else if(currentLang === 'bn') msg.lang = 'bn-BD';
                else msg.lang = 'en-US';
                msg.pitch = 1.2;
                window.speechSynthesis.speak(msg);
            }
        }

        // --- TRASH SOUND ---
        function playDeleteSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        }

        // --- STEPPED MATH SPEECH ---
        function speakMath(a, b, sum, newBlock) {
            if(!'speechSynthesis' in window) return;
            isInputLocked = true; 
            
            const p = MATH_PHRASES[currentLang];
            const tA = getLocalizedNumber(a);
            const tB = getLocalizedNumber(b);
            const tSum = getLocalizedNumber(sum);

            const sequence = [tA, p.plus, tB, p.equals, tSum];
            
            const isSquare = SQUARE_NUMBERS.includes(sum);
            if(isSquare) {
                // Phrase: Excellent! {n} is a square number!
                sequence.push(p.square.replace("{n}", tSum));
            }

            let i = 0;

            function speakNext() {
                if (i >= sequence.length) {
                    isInputLocked = false;
                    if(isSquare && newBlock) newBlock.classList.add('square-shake');
                    return;
                }
                
                const msg = new SpeechSynthesisUtterance(sequence[i]);
                if(currentLang === 'ar') msg.lang = 'ar-SA';
                else if(currentLang === 'bn') msg.lang = 'bn-BD';
                else msg.lang = 'en-US';
                msg.pitch = 1.2;
                
                msg.onend = () => {
                    setTimeout(speakNext, 150); 
                };
                
                window.speechSynthesis.speak(msg);
                i++;
            }
            speakNext();
        }

        // --- SPAWN & DRAG ---
        function spawnBlock(e, num) {
            if(isInputLocked) return;
            e.preventDefault();
            canvasHint.style.display = 'none'; 
            const block = createBlockVisual(num, true);
            block.id = `block-${blockIdCounter++}`;
            block.dataset.value = num;
            block.classList.add('spawn-anim');
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            canvas.appendChild(block);
            const rect = block.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            block.style.left = (clientX - canvasRect.left - rect.width/2) + 'px';
            block.style.top = (clientY - canvasRect.top - rect.height/2) + 'px';
            startDrag(e, block);
        }

        let activeBlock = null, startX = 0, startY = 0, mergeCandidate = null;

        canvas.addEventListener('mousedown', (e) => {
            const block = e.target.closest('.block-container');
            if(block) startDrag(e, block);
        });
        canvas.addEventListener('touchstart', (e) => {
            const block = e.target.closest('.block-container');
            if(block) { e.preventDefault(); startDrag(e, block); }
        }, {passive: false});

        function startDrag(e, block) {
            if(isInputLocked) return;
            activeBlock = block;
            activeBlock.style.zIndex = 1000;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = activeBlock.getBoundingClientRect();
            startX = clientX - rect.left; startY = clientY - rect.top;
            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove, {passive: false});
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchend', onEnd);
        }

        function onMove(e) {
            if(!activeBlock) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const canvasRect = canvas.getBoundingClientRect();
            let x = clientX - canvasRect.left - startX;
            let y = clientY - canvasRect.top - startY;
            activeBlock.style.left = x + 'px'; activeBlock.style.top = y + 'px';

            const trashRect = trashZone.getBoundingClientRect();
            const blockRect = activeBlock.getBoundingClientRect();
            if(isOverlap(blockRect, trashRect)) trashZone.classList.add('hover');
            else trashZone.classList.remove('hover');
            checkForMergePreview();
        }

        function isOverlap(r1, r2) {
            return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
        }

        function checkForMergePreview() {
            if(!activeBlock) return;
            const myRect = activeBlock.getBoundingClientRect();
            const others = Array.from(document.querySelectorAll('#canvas .block-container'));
            mergeCandidate = null;
            others.forEach(other => {
                if(other === activeBlock) return;
                other.classList.remove('merge-target');
                const otherRect = other.getBoundingClientRect();
                const c1 = {x: myRect.left + myRect.width/2, y: myRect.top + myRect.height/2};
                const c2 = {x: otherRect.left + otherRect.width/2, y: otherRect.top + otherRect.height/2};
                const dist = Math.hypot(c1.x - c2.x, c1.y - c2.y);
                if(dist < 60) { mergeCandidate = other; other.classList.add('merge-target'); }
            });
        }

        function onEnd(e) {
            if(!activeBlock) return;
            
            const trashRect = trashZone.getBoundingClientRect();
            const blockRect = activeBlock.getBoundingClientRect();
            if (isOverlap(blockRect, trashRect)) {
                playDeleteSound();
                activeBlock.remove();
                trashZone.classList.remove('hover');
                resetDrag();
                return;
            }

            if(mergeCandidate) {
                performMerge(activeBlock, mergeCandidate); resetDrag(); return;
            }
            activeBlock.style.zIndex = 10; resetDrag();
        }

        function resetDrag() {
            activeBlock = null; mergeCandidate = null;
            document.querySelectorAll('.block-container').forEach(b => b.classList.remove('merge-target'));
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchend', onEnd);
        }

        function performMerge(b1, b2) {
            const v1 = parseInt(b1.dataset.value);
            const v2 = parseInt(b2.dataset.value);
            const sum = v1 + v2;
            if(sum > 100) return;
            const rect = b2.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            const x = rect.left - canvasRect.left; const y = rect.top - canvasRect.top;
            b1.remove(); b2.remove();
            const newBlock = createBlockVisual(sum, true);
            newBlock.id = `block-${blockIdCounter++}`;
            newBlock.dataset.value = sum;
            newBlock.style.left = x + 'px'; newBlock.style.top = y + 'px';
            newBlock.classList.add('spawn-anim');
            canvas.appendChild(newBlock);
            speakMath(v1, v2, sum, newBlock);
        }

        function clearCanvas() {
            if(isInputLocked) return;
            canvas.innerHTML = '<div id="trash-zone">üóë</div><div id="canvas-hint" style="display:block">Drag Numbers Here!</div>';
        }

        function changeLanguage() {
            currentLang = document.getElementById('lang-select').value;
            const blocks = document.querySelectorAll('.block-container');
            blocks.forEach(b => {
                const val = parseInt(b.dataset.value);
                const lbl = b.querySelector('.block-value');
                if(lbl) lbl.innerText = getLocalizedNumber(val);
            });
            initSidebars();
        }

        initSidebars();
    </script>
</body>
</html>